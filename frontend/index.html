<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>EV Trip Optimizer Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f6fa;
      overflow: auto;
    }

    header {
      background-color: #2f3640;
      color: #f5f6fa;
      padding: 1rem;
      text-align: center;
      font-size: 1.8rem;
    }

    main {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 1rem;
      padding: 0.5rem;
      box-sizing: border-box;
    }

    .card {
      background-color: #fff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    form input,
    form select,
    form button {
      width: 100%;
      padding: 0.4rem;
      margin: 0.3rem 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 0.9rem;
    }

    form button {
      background-color: #44bd32;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      margin-top: 0.5rem;
    }

    form button:hover {
      background-color: #4cd137;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    #output {
      background-color: #f1f2f6;
      padding: 0.5rem;
      border-radius: 5px;
      flex: 1 1 auto;
      overflow: auto;
      font-size: 0.85rem;
      max-height: 200px;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 250px;
      gap: 0.5rem;
    }

    .charts>div {
      width: 100%;
      height: 100%;
    }

    @media (max-width: 1000px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .charts {
        grid-template-columns: 1fr;
        grid-auto-rows: 250px;
      }
    }

    #enhanceButton {
      display: none;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #e1b12c;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    #enhanceButton:hover {
      background-color: #f39c12;
    }
  </style>
</head>

<body>
  <header>EV Trip Optimizer Dashboard</header>
  <main>
    <div class="card">
      <h3>Trip Input</h3>
      <form id="tripForm">
        Distance (km): <input type="number" id="distance" required><br>
        Battery %: <input type="number" id="battery" required><br>
        Outside Temp (°C): <input type="number" id="outside" required><br>
        Battery Temp (°C): <input type="number" id="battTemp" required><br>
        Traffic:
        <select id="traffic">
          <option>Light</option>
          <option>Medium</option>
          <option>Heavy</option>
        </select><br>
        Driving:
        <select id="driving">
          <option>Highway</option>
          <option>Intracity</option>
          <option>Uphill</option>
          <option>Downhill</option>
        </select><br>
        Mode:
        <select id="mode">
          <option>Eco</option>
          <option>Normal</option>
          <option>Sport</option>
          <option>Custom</option>
        </select><br>
        Payload (kg): <input type="number" id="payload" required><br>
        <button type="submit">Optimize Trip</button>
      </form>
      <h3>Results</h3>
      <pre id="output"></pre>
      <button id="enhanceButton">Enhance Trip Settings</button>
    </div>
    <div class="card charts">
      <div id="batteryVsDistance"></div>
      <div id="speedVsConsumption"></div>
      <div id="modeComparison"></div>
      <div id="energyBreakdown"></div>
      <div id="projectedRange" style="grid-column: span 2;"></div>
    </div>
  </main>

  <script>
    const enhanceBtn = document.getElementById("enhanceButton");
    enhanceBtn.addEventListener("click", async () => {
      const data = {
        distance_km: parseFloat(document.getElementById("distance").value),
        battery_percent: parseFloat(document.getElementById("battery").value),
        outside_temp: parseFloat(document.getElementById("outside").value),
        battery_temp: parseFloat(document.getElementById("battTemp").value),
        traffic: document.getElementById("traffic").value,
        driving: document.getElementById("driving").value,
        mode: document.getElementById("mode").value,
        payload: parseFloat(document.getElementById("payload").value)
      };

      try {
        const res = await axios.post("http://127.0.0.1:8000/enhance_trip", data);
        const result = res.data;

        let outputText = "✅ Enhanced Trip Settings Applied:\n\n";
        outputText += "🚗 Recommended Settings:\n";
        for (const [key, value] of Object.entries(result.enhanced_settings)) {
          outputText += `   • ${key}: ${value}\n`;
        }

        outputText += `\n🚀 Possible Range: ${result.possible_range_km} km\n`;
        outputText += `🔋 Expected Battery After Trip: ${result.expected_battery_after_trip}%\n`;

        if (result.min_charge_needed_percent !== undefined) {
          outputText += `\n⚠️ Minimum Battery Required: ${result.min_charge_needed_percent}%\n`;
          outputText += "👉 Please charge before starting the trip.\n";
        }

        if (result.status) {
          outputText += `\nℹ️ ${result.status}`;
        }

        document.getElementById("output").innerText = outputText;

      } catch (err) {
        document.getElementById("output").innerText = "Error enhancing trip: " + err;
      }
    });


    document.getElementById("tripForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        distance_km: parseFloat(document.getElementById("distance").value),
        battery_percent: parseFloat(document.getElementById("battery").value),
        outside_temp: parseFloat(document.getElementById("outside").value),
        battery_temp: parseFloat(document.getElementById("battTemp").value),
        traffic: document.getElementById("traffic").value,
        driving: document.getElementById("driving").value,
        mode: document.getElementById("mode").value,
        payload: parseFloat(document.getElementById("payload").value)
      };

      try {
        const res = await axios.post("http://127.0.0.1:8000/optimize_trip", data);
        const result = res.data;
        document.getElementById("output").innerText = JSON.stringify(result, null, 2);

        enhanceBtn.style.display = result.distance_warning ? "block" : "none";

        const layout = { margin: { t: 30, l: 40, r: 10, b: 40 }, height: 300 };

        // Battery vs Distance
        Plotly.newPlot("batteryVsDistance", [{
          x: result.charts.battery_vs_distance.map(d => d.distance),
          y: result.charts.battery_vs_distance.map(d => d.battery_percent),
          mode: "lines+markers",
          name: "Battery %"
        }], { ...layout, title: "Battery % vs Distance" });

        // Speed vs Consumption
        Plotly.newPlot("speedVsConsumption", [{
          x: result.charts.speed_vs_consumption.map(d => d.speed),
          y: result.charts.speed_vs_consumption.map(d => d.consumption),
          mode: "lines+markers",
          name: "Consumption kWh/km"
        }], { ...layout, title: "Speed vs Consumption" });

        // Mode Comparison
        Plotly.newPlot("modeComparison", [{
          x: result.charts.mode_comparison.map(d => d.mode),
          y: result.charts.mode_comparison.map(d => d.range),
          type: "bar"
        }], { ...layout, title: "Mode Comparison (Predicted Range km)" });

        // Energy Breakdown
        Plotly.newPlot("energyBreakdown", [{
          values: Object.values(result.charts.energy_breakdown),
          labels: Object.keys(result.charts.energy_breakdown),
          type: "pie"
        }], { ...layout, title: "Energy Breakdown" });

        // Projected Range
        Plotly.newPlot("projectedRange", [{
          type: "indicator",
          mode: "gauge+number",
          value: result.predicted_range_km,
          title: { text: "Projected Range (km)" },
          gauge: { axis: { range: [0, Math.max(300, data.distance_km)] } }
        }], {
          margin: { t: 20, b: 20, l: 20, r: 20 },
          height: 350
        });

      } catch (err) {
        document.getElementById("output").innerText = "Error: " + err;
      }
    });

    enhanceBtn.addEventListener("click", () => {
      alert("Enhance functionality coming soon! Backend will adjust settings automatically.");
    });
  </script>
</body>

</html>